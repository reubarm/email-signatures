version: 2.1

executors:
  circle-ci-node:
    docker:
      - image: circleci/node:10.20

commands:
  fetch_master:
    steps:
      - run:
          name: Fetch the master branch
          command: git fetch origin master:master -f

  github_config:
    steps:
      - run:
          name: Setup GitHub
          command: |
            git config --global user.email $GITHUB_EMAIL
            git config --global user.name $GITHUB_USER
            git remote set-url origin https://${GH_TOKEN}@github.com/EqualsGroup/geometry-icons.git

  npm_config:
    steps:
      - run:
          name: Setup .npmrc credentials
          command: echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc

jobs:
  build:
    executor: circle-ci-node
    steps:
      - checkout
      - run:
          name: install
          command: npm install
      - run:
          name: setup env variables
          command: |
            echo "PERSONAL_ACCESS_TOKEN=$PERSONAL_ACCESS_TOKEN" >> .env
            echo "FILE_KEY=$FILE_KEY" >> .env
      - run:
          name: generate assets
          command: npm run generate
      - run:
          name: build
          command: npm run build
  release_production:
    executor: circle-ci-node
    steps:
      - checkout
      - run: yarn
      - run: yarn generate
      - run: yarn build
      - run: npm run semantic-release || true

workflows:
  on_commit:
    jobs:
      - build:
          name: Generate and build assets
      - release_production:
          name: Releases new build
          filters:
            branches:
              only:
                - master
