#!/usr/bin/env bash

# TODO: Format with prettier before writing to files

set -eu

# Check if we're running from a valid path

if [ ! -d ./node_modules/react-native ]; then
  echo 'This script needs to be run from the root of a React Native project!'
  exit 1
fi

# Define some constants and helper methods

MODULE_ROOT=./node_modules/@fairfx/wc-configs
MOBILE_ROOT="${MODULE_ROOT}"/mobile

bin_exists() {
  if hash "$1" 2>/dev/null; then
    return 0
  fi
  return 1
}

check_required_bin() {
  if ! bin_exists "$1"; then
    echo "$1 not found. Install via: $2"
    exit 1
  fi
}

# Check dependencies

check_requirements() {
  check_required_bin jq 'brew install jq'
}

printf 'Checking requirements... '
check_requirements
echo 'done.'

# Set up default configurations for shared configs
# TODO: Investigate moving parts of this to <moduleRoot>/shared/use.sh

printf 'Setting up shared configs... '

if [ "$(cat ./package.json | jq '.scripts.commit')" = null ]; then
  TEMP_FILE=$(mktemp)
  jq '.scripts = .scripts + { "commit": "wc-commitizen" }' ./package.json > "${TEMP_FILE}"
  mv "${TEMP_FILE}" ./package.json
fi

echo 'module.exports = {
  extends: ['\''@fairfx/wc-configs/shared/commitlint'\''],
};' > ./commitlint.config.js

printf "module.exports = require('@fairfx/wc-configs/shared/husky');\n" > ./husky.config.js

if [ ! -f ./wc.config.js ]; then
  echo 'module.exports = {
  scopes: [
    '\''screen'\'',
    '\''component'\'',
    '\''config'\'',
    '\''store'\'',
    '\''deps'\'',
    '\''dev-deps'\'',
    '\''release'\'',
    '\''multi'\'',
    '\''test'\'',
  ],
};' > ./wc.config.js
fi

echo 'done.'

# Set up default configurations for mobile only configs

printf 'Setting up mobile configs... '

"${MOBILE_ROOT}"/gitignore/use.sh

if [ "$(cat ./package.json | jq '.jest')" != null ]; then
  TEMP_FILE=$(mktemp)
  jq 'del(.jest)' ./package.json > "${TEMP_FILE}"
  mv "${TEMP_FILE}" ./package.json
fi

echo 'const jestConfig = require('\''@fairfx/wc-configs/mobile/jest/jest'\'');

module.exports = Object.assign(jestConfig, {
  // Your overrides here
});' > ./jest.config.js

if [ ! -d ./__tests__ ]; then
  mkdir ./__tests__
fi

rm -f ./__tests__/App-test.js

if [ ! -f ./__tests__/setup.ts ]; then
  touch ./__tests__/setup.ts
fi

printf "module.exports = require('@fairfx/wc-configs/shared/prettier/.prettierrc');\n" > ./.prettierrc.js

echo '{
  "extends": "./node_modules/@fairfx/wc-configs/mobile/tsconfig/tsconfig.json"
}' > ./tsconfig.json

echo '{
  "extends": ["@fairfx/wc-configs/mobile/tslint/tslint"]
}' > ./tslint.json

"${MOBILE_ROOT}"/vscode/use.sh

echo 'done.'
