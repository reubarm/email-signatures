let fs = require('fs');
const path = require('path');
let { getPackages } = require('@commitlint/config-lerna-scopes').utils;
let findRoot = require('find-root');

let rootPath = findRoot(__dirname, dir =>
  fs.existsSync(path.resolve(dir, '.git'))
);

let lernaConfigPath = `${rootPath}/lerna.json`;
let wcConfigPath = `${rootPath}/wc.config.js`;

function isMonorepo() {
  return fs.existsSync(lernaConfigPath);
}

function getScopes() {
  if (isMonorepo()) {
    return ctx =>
      getPackages(ctx).then(packages => [
        2,
        'always',
        [...packages, 'monorepo', 'multi'],
      ]);
  } else {
    if (fs.existsSync(wcConfigPath)) {
      let config = require(wcConfigPath);

      if (
        !config ||
        !config.scopes ||
        !(config.scopes instanceof Array) ||
        config.scopes.length === 0
      ) {
        exit(
          "Configuration error - please ensure that you define a 'scopes' array in wc.config.json, with at least one item."
        );
      }
      let pattern = /^[a-z]+(-[a-z]+)*$/;
      let problems = config.scopes.filter(scope => !pattern.test(scope));

      if (problems.length > 0) {
        exit(`Configuration error - some of the scopes you defined in wc.config.json do not match hythen delimiter-separated words (e.g. a-scope).
Problem scopes: ${problems.map(scope => `"${scope}"`)}`);
      }

      return [2, 'always', config.scopes];
    } else {
      exit(`We've detected that you are in a single package repository.
To determine the conventional commit scopes acceptable you need to define them in a wc.config.json file in the root of the repository.`);
    }
  }
}

function exit(message) {
  console.error(
    `[wc-configs] ${message}
Please refer to the documentation available at https://github.com/FairFXGroup/willow-common/blob/develop/packages/wc-configs/README.md#additional-configuration
Exiting...`
  );
  process.exit(-1);
}

module.exports = {
  rootPath,
  getScopes,
  isMonorepo,
};
